# 2026-01-16: WhatsApp Broadcast Fix - FINAL SOLUTION

## Problem Identified
✅ **broadcast-webhook works** - Test message delivered successfully
❌ **admin-api times out** - Waits for webhook response but webhook takes too long (1 second per recipient)

## Root Cause
The `admin-api` edge function calls `broadcast-webhook` with `AbortSignal.timeout(10000)` and waits for the response. For broadcasts with many recipients, the webhook takes longer than 10 seconds, causing timeout.

## Solution
Make webhook calls **fire-and-forget** - trigger the webhook but don't wait for response.

### Changes Required in `/supabase/functions/admin-api/index.ts`

**Line ~722, ~851, ~1734**: Remove `signal: AbortSignal.timeout(10000)` and don't await response

```typescript
// BEFORE (waits for response, times out):
const webhookResponse = await fetch(webhookUrl, {
  method: 'POST',
  headers: {...},
  body: webhookPayload,
  signal: AbortSignal.timeout(10000)  // ← REMOVE THIS
})
const responseText = await webhookResponse.text()  // ← DON'T WAIT

// AFTER (fire-and-forget):
fetch(webhookUrl, {
  method: 'POST',
  headers: {...},
  body: webhookPayload
}).catch(err => console.error('Webhook trigger failed:', err.message))
// Don't await, just trigger and continue
```

## Deployment Steps
1. Update `admin-api/index.ts` with fire-and-forget webhook calls
2. Deploy to Supabase: `supabase functions deploy admin-api`
3. Test broadcast - should complete immediately
4. Check `broadcasts` table - webhook will update it asynchronously

## Expected Behavior After Fix
- Admin clicks "Broadcast" → Immediate success response
- Dashboard shows "processing" status
- Webhook runs in background, sends WhatsApp messages
- Webhook updates `broadcasts` table with success/failure counts
- Dashboard refreshes to show final counts

## Files to Modify
- `/workspaces/moments/supabase/functions/admin-api/index.ts` (3 locations)

## Testing
```bash
# After deployment, test broadcast
curl -X POST "https://bxmdzcxejcxbinghtyfw.supabase.co/functions/v1/admin-api/campaigns/ID/broadcast" \
  -H "Authorization: Bearer TOKEN"

# Should return immediately with success
# Check broadcasts table after 5-10 seconds for updated counts
```
