<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unami Foundation Moments</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="stylesheet" href="/css/design-system.css">
    <meta name="description" content="Community updates and opportunities across South Africa">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; line-height: 1.6; }
        
        /* Navigation */
        .nav { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .nav-container { max-width: 800px; margin: 0 auto; padding: 0 1rem; display: flex; justify-content: space-between; align-items: center; height: 60px; }
        .nav-logo { font-size: 1.5rem; font-weight: bold; color: #2563eb; text-decoration: none; }
        .nav-links { display: flex; gap: 2rem; align-items: center; }
        .nav-links a { text-decoration: none; color: #374151; font-weight: 500; transition: color 0.2s; }
        .nav-links a:hover { color: #2563eb; }
        .nav-toggle { display: none; background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        
        .container { max-width: 800px; margin: 0 auto; padding: 1rem; }
        .header { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; padding: 2rem 1rem; text-align: center; margin-bottom: 2rem; border-radius: 0 0 1rem 1rem; }
        .header h1 { font-size: clamp(1.5rem, 5vw, 2.5rem); margin-bottom: 0.5rem; }
        .header p { opacity: 0.9; font-size: clamp(0.875rem, 3vw, 1.125rem); }
        .stats-bar { display: flex; justify-content: space-around; background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; }
        .stat { text-align: center; }
        .stat-number { font-size: 1.5rem; font-weight: bold; }
        .stat-label { font-size: 0.75rem; opacity: 0.8; }
        .filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .filter-select { padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; background: white; font-size: 1rem; }
        .moments-grid { display: grid; gap: 1.5rem; }
        .moment-card { background: white; border-radius: 1rem; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; transition: all 0.2s; }
        .moment-card:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .moment-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.75rem; color: #1f2937; }
        .moment-content { color: #374151; margin-bottom: 1rem; }
        .moment-meta { display: flex; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
        .region-badge { background: #dbeafe; color: #1e40af; }
        .category-badge { background: #f3e8ff; color: #7c3aed; }
        .sponsored-badge { background: #fef3c7; color: #92400e; }
        .moment-content { color: #374151; margin-bottom: 1rem; }
        .moment-content.collapsed { max-height: 4.5em; overflow: hidden; position: relative; }
        .moment-content.collapsed::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 1.5em; background: linear-gradient(transparent, white); }
        .expand-content { background: none; border: none; color: #2563eb; font-size: 0.875rem; cursor: pointer; padding: 0; margin-top: 0.5rem; }
        .expand-content:hover { text-decoration: underline; }
        .moment-media { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; margin: 1rem 0; }
        .media-preview { position: relative; border-radius: 0.5rem; overflow: hidden; aspect-ratio: 1; background: #f3f4f6; }
        .media-preview img, .media-preview video { width: 100%; height: 100%; object-fit: cover; cursor: pointer; }
        .media-overlay { position: absolute; top: 0.5rem; right: 0.5rem; background: rgba(0,0,0,0.7); color: white; font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 0.25rem; }
        .media-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2rem; color: #6b7280; }
        .footer { background: #f8fafc; border-top: 1px solid #e5e7eb; padding: 2rem 1rem; margin-top: 3rem; text-align: center; color: #6b7280; }
        .footer p { margin-bottom: 0.5rem; }
        .footer a { color: #2563eb; text-decoration: none; }
        .footer a:hover { text-decoration: underline; }
        .moment-footer { display: flex; justify-content: between; align-items: center; font-size: 0.875rem; color: #6b7280; }
        .loading { text-align: center; padding: 3rem; color: #6b7280; }
        .empty-state { text-align: center; padding: 3rem; color: #6b7280; }
        .empty-icon { font-size: 3rem; margin-bottom: 1rem; }
        .join-whatsapp { background: #25D366; color: white; padding: 1rem 2rem; border-radius: 0.5rem; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; font-weight: 500; margin-top: 1rem; }
        .join-whatsapp:hover { background: #128C7E; }
        @media (max-width: 768px) {
            .container { padding: 0.5rem; }
            .filters { grid-template-columns: 1fr; }
            .moment-meta { flex-direction: column; gap: 0.5rem; }
            .stats-bar { flex-direction: column; gap: 1rem; }
            .nav-container { padding: 0 0.5rem; }
            .nav-links { display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; flex-direction: column; padding: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
            .nav-links.active { display: flex; }
            .nav-toggle { display: block; }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-container">
            <a href="/" class="nav-logo">üåç Unami Moments</a>
            <div class="nav-links" id="nav-links">
                <a href="/">Home</a>
                <a href="/moments">Community</a>
                <a href="https://wa.me/27658295041?text=START" target="_blank">Join WhatsApp</a>
                <a href="/admin-dashboard.html">Admin</a>
            </div>
            <button class="nav-toggle" id="nav-toggle">‚ò∞</button>
        </div>
    </nav>

    <div class="header">
        <h1>üåç Your Community Moments</h1>
        <p>Real stories, opportunities, and updates from your South African community</p>
        <div class="stats-bar" id="stats-bar">
            <div class="stat">
                <div class="stat-number" id="total-moments">-</div>
                <div class="stat-label">Stories Shared</div>
            </div>
            <div class="stat">
                <div class="stat-number" id="active-subscribers">-</div>
                <div class="stat-label">Community Members</div>
            </div>
            <div class="stat">
                <div class="stat-number" id="total-broadcasts">-</div>
                <div class="stat-label">Updates Sent</div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="filters">
            <select class="filter-select" id="region-filter">
                <option value="">All Regions</option>
                <option value="KZN">KwaZulu-Natal</option>
                <option value="WC">Western Cape</option>
                <option value="GP">Gauteng</option>
                <option value="EC">Eastern Cape</option>
                <option value="FS">Free State</option>
                <option value="LP">Limpopo</option>
                <option value="MP">Mpumalanga</option>
                <option value="NC">Northern Cape</option>
                <option value="NW">North West</option>
            </select>
            
            <select class="filter-select" id="category-filter">
                <option value="">All Categories</option>
                <option value="Education">Education</option>
                <option value="Safety">Safety</option>
                <option value="Culture">Culture</option>
                <option value="Opportunity">Opportunity</option>
                <option value="Events">Events</option>
                <option value="Health">Health</option>
                <option value="Technology">Technology</option>
                <option value="Community">Community</option>
            </select>
            
            <select class="filter-select" id="source-filter">
                <option value="">All Sources</option>
                <option value="community">Community Reports</option>
                <option value="admin">Official Updates</option>
            </select>
        </div>
        
        <div id="moments-container" class="moments-grid">
            <div class="loading">Loading moments...</div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2026 Unami Foundation. All rights reserved. | Proudly South African üáøüá¶</p>
            <p><a href="mailto:info@unamifoundation.org">info@unamifoundation.org</a> | <a href="https://unamifoundation.org" target="_blank">unamifoundation.org</a></p>
        </div>
    </footer>

    <script>
        // Immersive PWA functionality
        let currentFilters = { region: '', category: '', source: '' };
        
        // Mobile navigation toggle
        document.getElementById('nav-toggle').addEventListener('click', () => {
            document.getElementById('nav-links').classList.toggle('active');
        });
        
        // Close mobile nav when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.nav')) {
                document.getElementById('nav-links').classList.remove('active');
            }
        });
        
        async function loadStats() {
            try {
                const response = await fetch('/supabase/functions/v1/public-api/stats');
                const stats = await response.json();
                
                document.getElementById('total-moments').textContent = stats.totalMoments || 0;
                document.getElementById('active-subscribers').textContent = stats.activeSubscribers || 0;
                document.getElementById('total-broadcasts').textContent = stats.totalBroadcasts || 0;
            } catch (error) {
                console.error('Failed to load stats:', error);
                // Fallback to placeholder values
                document.getElementById('total-moments').textContent = '-';
                document.getElementById('active-subscribers').textContent = '-';
                document.getElementById('total-broadcasts').textContent = '-';
            }
        }

        async function loadMoments() {
            try {
                const params = new URLSearchParams();
                if (currentFilters.region) params.append('region', currentFilters.region);
                if (currentFilters.category) params.append('category', currentFilters.category);
                if (currentFilters.source) params.append('source', currentFilters.source);
                
                const response = await fetch(`/supabase/functions/v1/public-api/moments?${params}`);
                const data = await response.json();
                displayMoments(data.moments || []);
            } catch (error) {
                console.error('Failed to load moments:', error);
                document.getElementById('moments-container').innerHTML = 
                    '<div class="loading">Unable to load moments. Please try again later.</div>';
            }
        }

        function displayMoments(moments) {
            const container = document.getElementById('moments-container');
            
            if (moments.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üå±</div>
                        <h3>Community moments coming soon</h3>
                        <p>We're building something amazing for South African communities. Join our WhatsApp to be the first to receive updates.</p>
                        <a href="https://wa.me/27658295041?text=START" class="join-whatsapp">
                            üì± Join WhatsApp Community
                        </a>
                    </div>
                `;
                return;
            }

            container.innerHTML = moments.map(moment => `
                <div class="moment-card">
                    ${renderSponsorBranding(moment.sponsors, moment.is_sponsored)}
                    <h3 class="moment-title">${escapeHtml(moment.title)}</h3>
                    <div class="moment-content ${moment.content.length > 200 ? 'collapsed' : ''}" data-full-content="${escapeHtml(moment.content)}">
                        ${escapeHtml(moment.content.length > 200 ? moment.content.substring(0, 200) : moment.content)}
                    </div>
                    ${moment.content.length > 200 ? '<button class="expand-content" onclick="toggleContent(this)">Read more</button>' : ''}
                    
                    ${renderMedia(moment.media_urls)}
                    
                    <div class="moment-meta">
                        <span class="badge region-badge">${escapeHtml(moment.region)}</span>
                        <span class="badge category-badge">${escapeHtml(moment.category)}</span>
                        ${moment.is_sponsored ? '<span class="badge sponsored-badge">Sponsored</span>' : ''}
                        ${moment.content_source === 'community' ? '<span class="badge" style="background: #e0f2fe; color: #0277bd;">Community</span>' : ''}
                        ${moment.content_source === 'campaign' ? '<span class="badge" style="background: #fff3e0; color: #f57c00;">Campaign</span>' : ''}
                    </div>
                    
                    <div class="moment-footer">
                        <span>${formatDate(moment.broadcasted_at)}</span>
                        ${renderSponsorAttribution(moment.sponsors, moment.is_sponsored)}
                    </div>
                </div>
            `).join('');
        }
        
        function renderSponsorBranding(sponsor, isSponsored) {
            if (!isSponsored || !sponsor) return '';
            
            const logoHtml = sponsor.logo_url ? 
                `<img src="${escapeHtml(sponsor.logo_url)}" alt="${escapeHtml(sponsor.display_name)} logo" style="height: 24px; width: auto; margin-right: 8px;">` : '';
            
            return `
                <div class="sponsor-branding" style="display: flex; align-items: center; margin-bottom: 12px; padding: 8px; background: #f8fafc; border-radius: 6px; border-left: 3px solid #fbbf24;">
                    ${logoHtml}
                    <span style="font-size: 0.75rem; color: #6b7280; font-weight: 500;">Sponsored by ${escapeHtml(sponsor.display_name)}</span>
                </div>
            `;
        }
        
        function renderSponsorAttribution(sponsor, isSponsored) {
            if (!isSponsored || !sponsor) return '';
            return `<span style="font-size: 0.75rem; color: #6b7280;">by ${escapeHtml(sponsor.display_name)}</span>`;
        }
        
        function renderMedia(mediaUrls) {
            if (!mediaUrls || mediaUrls.length === 0) return '';
            
            const mediaItems = mediaUrls.slice(0, 4); // Show max 4 items
            const hasMore = mediaUrls.length > 4;
            
            return `
                <div class="moment-media">
                    ${mediaItems.map((url, index) => {
                        const ext = url.split('.').pop().toLowerCase();
                        if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) {
                            return `
                                <div class="media-preview">
                                    <img src="${escapeHtml(url)}" alt="Moment image" onclick="openMedia('${escapeHtml(url)}')">
                                    ${hasMore && index === 3 ? `<div class="media-overlay">+${mediaUrls.length - 4}</div>` : ''}
                                </div>
                            `;
                        } else if (['mp4', 'webm', 'mov'].includes(ext)) {
                            return `
                                <div class="media-preview">
                                    <video onclick="openMedia('${escapeHtml(url)}')">
                                        <source src="${escapeHtml(url)}">
                                    </video>
                                    <div class="media-icon">‚ñ∂Ô∏è</div>
                                    ${hasMore && index === 3 ? `<div class="media-overlay">+${mediaUrls.length - 4}</div>` : ''}
                                </div>
                            `;
                        } else if (['mp3', 'wav', 'ogg', 'm4a'].includes(ext)) {
                            return `
                                <div class="media-preview">
                                    <div class="media-icon">üéß</div>
                                    <audio controls style="position: absolute; bottom: 0; width: 100%; height: 30px;">
                                        <source src="${escapeHtml(url)}">
                                    </audio>
                                </div>
                            `;
                        }
                        return `
                            <div class="media-preview">
                                <div class="media-icon">üìÑ</div>
                                <a href="${escapeHtml(url)}" target="_blank" style="position: absolute; inset: 0;"></a>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function toggleContent(button) {
            const contentDiv = button.previousElementSibling;
            const isCollapsed = contentDiv.classList.contains('collapsed');
            
            if (isCollapsed) {
                contentDiv.innerHTML = escapeHtml(contentDiv.dataset.fullContent);
                contentDiv.classList.remove('collapsed');
                button.textContent = 'Read less';
            } else {
                const shortContent = contentDiv.dataset.fullContent.substring(0, 200);
                contentDiv.innerHTML = escapeHtml(shortContent);
                contentDiv.classList.add('collapsed');
                button.textContent = 'Read more';
            }
        }
        
        function openMedia(url) {
            window.open(url, '_blank');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            
            return date.toLocaleDateString('en-ZA', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        // Filter functionality
        document.getElementById('region-filter').addEventListener('change', (e) => {
            currentFilters.region = e.target.value;
            loadMoments();
        });
        
        document.getElementById('category-filter').addEventListener('change', (e) => {
            currentFilters.category = e.target.value;
            loadMoments();
        });
        
        document.getElementById('source-filter').addEventListener('change', (e) => {
            currentFilters.source = e.target.value;
            loadMoments();
        });

        // Load data on page load
        loadStats();
        loadMoments();
        
        // Real-time updates every 30 seconds for community content
        setInterval(() => {
            loadStats();
            loadMoments();
        }, 30 * 1000);
    </script>
    <script src="/js/analytics.js"></script>
</body>
</html>