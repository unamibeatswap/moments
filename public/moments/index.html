<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unami Foundation Moments App</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="stylesheet" href="/css/design-system.css">
    <link rel="stylesheet" href="/css/moments-renderer.css">
    <meta name="description" content="Community updates and opportunities across South Africa">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; line-height: 1.6; }
        
        /* Navigation */
        .nav { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .nav-container { max-width: 800px; margin: 0 auto; padding: 0 1rem; display: flex; justify-content: space-between; align-items: center; height: 60px; }
        .nav-logo { font-size: 1.5rem; font-weight: bold; color: #2563eb; text-decoration: none; }
        .nav-links { display: flex; gap: 2rem; align-items: center; }
        .nav-links a { text-decoration: none; color: #374151; font-weight: 500; transition: color 0.2s; }
        .nav-links a:hover { color: #2563eb; }
        .nav-toggle { display: none; background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        
        .container { max-width: 800px; margin: 0 auto; padding: 1rem; }
        .header { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; padding: 2rem 1rem; text-align: center; margin-bottom: 2rem; border-radius: 0 0 1rem 1rem; }
        .header h1 { font-size: clamp(1.5rem, 5vw, 2.5rem); margin-bottom: 0.5rem; }
        .header p { opacity: 0.9; font-size: clamp(0.875rem, 3vw, 1.125rem); }
        .stats-bar { display: flex; justify-content: space-around; background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; }
        .stat { text-align: center; color: white; }
        .stat-number { font-size: 1.5rem; font-weight: bold; color: white; }
        .stat-label { font-size: 0.75rem; opacity: 0.9; color: white; }
        .filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .filter-select { padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; background: white; font-size: 1rem; }
        .moments-grid { display: grid; gap: 1.5rem; }
        .moment-card { background: white; border-radius: 1rem; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; transition: all 0.2s; }
        .moment-card:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .moment-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.75rem; color: #1f2937; }
        .moment-content { color: #374151; margin-bottom: 1rem; }
        .moment-meta { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: center; }
        .badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; display: inline-block; white-space: nowrap; }
        .region-badge { background: #dbeafe; color: #1e40af; }
        .category-badge { background: #f3e8ff; color: #7c3aed; }
        .sponsored-badge { background: #fef3c7; color: #92400e; }
        .moment-content { color: #374151; margin-bottom: 1rem; }
        .moment-content.collapsed { max-height: 4.5em; overflow: hidden; position: relative; }
        .moment-content.collapsed::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 1.5em; background: linear-gradient(transparent, white); }
        .expand-content { background: none; border: none; color: #2563eb; font-size: 0.875rem; cursor: pointer; padding: 0; margin-top: 0.5rem; }
        .expand-content:hover { text-decoration: underline; }
        .moment-media { 
            display: grid; 
            gap: 0.5rem; 
            margin: 1rem 0; 
        }
        .moment-media.single { grid-template-columns: 1fr; }
        .moment-media.double { grid-template-columns: 1fr 1fr; }
        .moment-media.triple { grid-template-columns: 1fr 1fr 1fr; }
        .moment-media.multiple { grid-template-columns: 1fr 1fr; }
        
        .media-preview { 
            position: relative; 
            border-radius: 0.5rem; 
            overflow: hidden; 
            background: #f3f4f6; 
            display: block;
            cursor: pointer;
        }
        .media-preview.single { aspect-ratio: 16/9; max-height: 300px; }
        .media-preview.double { aspect-ratio: 1; }
        .media-preview.triple { aspect-ratio: 1; }
        .media-preview.multiple { aspect-ratio: 1; }
        
        .media-preview img, .media-preview video { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            display: block;
            transition: transform 0.2s;
        }
        .media-preview:hover img, .media-preview:hover video {
            transform: scale(1.05);
        }
        .media-overlay { position: absolute; top: 0.5rem; right: 0.5rem; background: rgba(0,0,0,0.7); color: white; font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 0.25rem; }
        .media-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2rem; color: #6b7280; }
        .moment-comments { margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; }
        .comments-header { font-size: 1rem; font-weight: 600; color: #374151; margin-bottom: 1rem; }
        .comment-item { background: #f8fafc; border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 0.75rem; }
        .comment-item.featured { border-left: 3px solid #2563eb; background: #eff6ff; }
        .comment-content { color: #374151; margin-bottom: 0.5rem; font-size: 0.875rem; }
        .comment-meta { display: flex; gap: 0.75rem; font-size: 0.75rem; color: #6b7280; }
        .comment-author { font-weight: 500; }
        .comment-replies { color: #2563eb; }
        .comment-replies-list { margin-top: 0.5rem; padding-left: 1rem; border-left: 2px solid #e5e7eb; }
        .comment-reply { margin-bottom: 0.5rem; }
        .reply-content { font-size: 0.8125rem; color: #4b5563; margin-bottom: 0.25rem; }
        .reply-meta { font-size: 0.6875rem; color: #9ca3af; }
        .comments-more { text-align: center; margin-top: 0.75rem; }
        .expand-comments { background: none; border: 1px solid #d1d5db; color: #374151; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; }
        .expand-comments:hover { background: #f3f4f6; }
        .footer { background: #1f2937; color: white; padding: 60px 0 30px; text-align: center; }
        .footer-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 40px; margin-bottom: 40px; text-align: left; }
        .footer-section h4 { font-size: 1.2rem; margin-bottom: 20px; color: #60a5fa; }
        .footer-section p, .footer-section a { color: #d1d5db; text-decoration: none; }
        .footer-section a:hover { color: white; }
        .footer-bottom { border-top: 1px solid #374151; padding-top: 30px; text-align: center; color: #9ca3af; }
        .moment-footer { display: flex; justify-content: between; align-items: center; font-size: 0.875rem; color: #6b7280; }
        .loading { text-align: center; padding: 3rem; color: #6b7280; }
        .empty-state { text-align: center; padding: 3rem; color: #6b7280; }
        .empty-icon { font-size: 3rem; margin-bottom: 1rem; }
        .join-whatsapp { background: #25D366; color: white; padding: 1rem 2rem; border-radius: 0.5rem; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; font-weight: 500; margin-top: 1rem; }
        .join-whatsapp:hover { background: #128C7E; }
        @media (max-width: 768px) {
            .container { padding: 0.5rem; }
            .filters { grid-template-columns: 1fr; }
            .moment-meta { gap: 0.375rem; }
            .badge { padding: 0.2rem 0.6rem; font-size: 0.7rem; }
            .stats-bar { 
                flex-direction: column; 
                gap: 1rem; 
                text-align: center;
            }
            .stat {
                padding: 0.5rem;
                background: rgba(255,255,255,0.15);
                border-radius: 0.375rem;
            }
            .stat-number {
                font-size: 1.75rem;
                color: white !important;
                text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            }
            .stat-label {
                color: white !important;
                opacity: 0.95;
                font-weight: 500;
            }
            .nav-container { padding: 0 0.5rem; }
            .nav-links { display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; flex-direction: column; padding: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
            .nav-links.active { display: flex; }
            .nav-toggle { display: block; }
            .footer { padding: 40px 0 20px; }
            .footer-content { text-align: center; }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-container">
            <a href="/" class="nav-logo">
                <img src="/logo.png" alt="Unami Foundation" style="height: 24px; width: auto; margin-right: 8px; vertical-align: middle;" onerror="this.style.display='none'">
                Moments App
            </a>
            <div class="nav-links" id="nav-links">
                <a href="/">Home</a>
                <a href="/moments">Moments</a>
                <a href="https://wa.me/27658295041?text=START" target="_blank">Join WhatsApp</a>
                <a href="/admin-dashboard.html">Admin</a>
            </div>
            <button class="nav-toggle" id="nav-toggle">‚ò∞</button>
        </div>
    </nav>

    <div class="header">
        <h1>
            Your Community Moments
        </h1>
        <p>Real stories, opportunities, and updates from your South African community</p>
        <div class="stats-bar" id="stats-bar">
            <div class="stat">
                <div class="stat-number" id="total-moments">-</div>
                <div class="stat-label">Stories Shared</div>
            </div>
            <div class="stat">
                <div class="stat-number" id="active-subscribers">-</div>
                <div class="stat-label">Community Members</div>
            </div>
            <div class="stat">
                <div class="stat-number" id="total-broadcasts">-</div>
                <div class="stat-label">Updates Sent</div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="filters">
            <select class="filter-select" id="region-filter">
                <option value="">All Regions</option>
                <option value="KZN">KwaZulu-Natal</option>
                <option value="WC">Western Cape</option>
                <option value="GP">Gauteng</option>
                <option value="EC">Eastern Cape</option>
                <option value="FS">Free State</option>
                <option value="LP">Limpopo</option>
                <option value="MP">Mpumalanga</option>
                <option value="NC">Northern Cape</option>
                <option value="NW">North West</option>
            </select>
            
            <select class="filter-select" id="category-filter">
                <option value="">All Categories</option>
                <option value="Education">Education</option>
                <option value="Safety">Safety</option>
                <option value="Culture">Culture</option>
                <option value="Opportunity">Opportunity</option>
                <option value="Events">Events</option>
                <option value="Health">Health</option>
                <option value="Technology">Technology</option>
                <option value="Community">Community</option>
            </select>
            
            <select class="filter-select" id="source-filter">
                <option value="">All Sources</option>
                <option value="community">Community Reports</option>
                <option value="admin">Official Updates</option>
            </select>
        </div>
        
        <div id="moments-container" class="moments-grid">
            <div class="loading">Loading moments...</div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>Moments App</h4>
                    <p>Empowering South African communities through accessible, privacy-respecting, WhatsApp-native engagement.</p>
                </div>
                <div class="footer-section">
                    <h4>Quick Links</h4>
                    <p><a href="/moments">Moments App</a></p>
                    <p><a href="https://wa.me/27658295041?text=START">Join WhatsApp</a></p>
                    <p><a href="/admin-dashboard.html">Admin Dashboard</a></p>
                    <p><a href="/health">System Status</a></p>
                </div>
                <div class="footer-section">
                    <h4>Categories</h4>
                    <p>Education ‚Ä¢ Safety ‚Ä¢ Culture</p>
                    <p>Opportunities ‚Ä¢ Events ‚Ä¢ Health</p>
                    <p>Technology ‚Ä¢ Community</p>
                </div>
                <div class="footer-section">
                    <h4>Contact</h4>
                    <p>WhatsApp: +27 65 829 5041</p>
                    <p>Email: info@unamifoundation.org</p>
                    <p>Privacy Policy ‚Ä¢ Terms of Service</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2026 Unami Foundation. All rights reserved. | Proudly South African üáøüá¶</p>
            </div>
        </div>
    </footer>

    <script>
        // Immersive PWA functionality
        let currentFilters = { region: '', category: '', source: '' };
        let currentPage = 1;
        let itemsPerPage = 10;
        let allMoments = [];
        
        // Mobile navigation toggle
        document.getElementById('nav-toggle').addEventListener('click', () => {
            document.getElementById('nav-links').classList.toggle('active');
        });
        
        // Close mobile nav when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.nav')) {
                document.getElementById('nav-links').classList.remove('active');
            }
        });
        
        async function loadStats() {
            try {
                const response = await fetch('https://bxmdzcxejcxbinghtyfw.supabase.co/functions/v1/admin-api/analytics');
                const stats = await response.json();
                
                document.getElementById('total-moments').textContent = stats.totalMoments || 0;
                document.getElementById('active-subscribers').textContent = stats.activeSubscribers || 0;
                document.getElementById('total-broadcasts').textContent = stats.totalBroadcasts || 0;
            } catch (error) {
                console.error('Failed to load stats:', error);
                document.getElementById('total-moments').textContent = '0';
                document.getElementById('active-subscribers').textContent = '0';
                document.getElementById('total-broadcasts').textContent = '0';
            }
        }

        async function loadMoments() {
            try {
                const params = new URLSearchParams();
                if (currentFilters.region) params.append('region', currentFilters.region);
                if (currentFilters.category) params.append('category', currentFilters.category);
                if (currentFilters.source) params.append('source', currentFilters.source);
                // Add order param for latest first
                params.append('order', 'created_at.desc');
                
                const response = await fetch(`https://bxmdzcxejcxbinghtyfw.supabase.co/rest/v1/moments?status=eq.broadcasted&publish_to_pwa=eq.true&select=*&${params}`, {
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4bWR6Y3hlamN4YmluZ2h0eWZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNzMzOTYsImV4cCI6MjA4Mzc0OTM5Nn0.ccwWS_LPLjUrY8zqHD0Q7pTEamdN-QV0bv6f0B1uBUU'
                    }
                });
                let moments = await response.json();
                
                // Sort by created_at descending (latest first) as backup
                if (moments && Array.isArray(moments)) {
                    moments = moments.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                }
                
                allMoments = moments || [];
                currentPage = 1;
                displayMoments();
            } catch (error) {
                console.error('Failed to load moments:', error);
                document.getElementById('moments-container').innerHTML = 
                    '<div class="loading">Unable to load moments. Please try again later.</div>';
            }
        }

        function displayMoments() {
            // Use the enhanced Markdown renderer
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedMoments = allMoments.slice(startIndex, endIndex);
            
            displayMomentsWithMarkdown(paginatedMoments);
            
            // Add pagination controls
            addPaginationControls(Math.ceil(allMoments.length / itemsPerPage));
        }
        
        function addPaginationControls(totalPages) {
            const container = document.getElementById('moments-container');
            if (totalPages <= 1) return;
            
            let paginationHtml = '<div style="display: flex; justify-content: center; gap: 0.5rem; margin-top: 2rem; flex-wrap: wrap;">';
            
            // Previous button
            if (currentPage > 1) {
                paginationHtml += `<button onclick="goToPage(${currentPage - 1})" class="btn btn-secondary" style="background: #6b7280;">‚Üê Previous</button>`;
            }
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    paginationHtml += `<button class="btn" style="background: #2563eb; cursor: default;">${i}</button>`;
                } else if (i <= 3 || i > totalPages - 3 || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    paginationHtml += `<button onclick="goToPage(${i})" class="btn btn-secondary" style="background: #e5e7eb; color: #374151;">${i}</button>`;
                } else if (i === 4 || i === totalPages - 3) {
                    paginationHtml += `<span class="btn" style="background: transparent; cursor: default;">...</span>`;
                }
            }
            
            // Next button
            if (currentPage < totalPages) {
                paginationHtml += `<button onclick="goToPage(${currentPage + 1})" class="btn btn-secondary" style="background: #6b7280;">Next ‚Üí</button>`;
            }
            
            paginationHtml += '</div>';
            container.insertAdjacentHTML('afterend', paginationHtml);
        }
        
        function goToPage(page) {
            currentPage = page;
            displayMoments();
            // Scroll to top
            document.querySelector('.header').scrollIntoView({ behavior: 'smooth' });
        }
        
        function displayMoments() {
            // Use the enhanced Markdown renderer
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedMoments = allMoments.slice(startIndex, endIndex);
            
            // Remove old pagination before displaying
            const oldPagination = document.querySelector('[style*="justify-content: center"]');
            if (oldPagination) oldPagination.remove();
            
            displayMomentsWithMarkdown(paginatedMoments);
            
            // Add pagination controls
            addPaginationControls(Math.ceil(allMoments.length / itemsPerPage));
        }
        
        function renderSponsorBranding(sponsor, isSponsored) {
            if (!isSponsored || !sponsor) return '';
            
            const logoHtml = sponsor.logo_url ? 
                `<img src="${escapeHtml(sponsor.logo_url)}" alt="${escapeHtml(sponsor.display_name)} logo" style="height: 24px; width: auto; margin-right: 8px;" onerror="this.style.display='none'">` : '';
            
            return `
                <div class="sponsor-branding" style="display: flex; align-items: center; margin-bottom: 12px; padding: 8px; background: #f8fafc; border-radius: 6px; border-left: 3px solid #fbbf24;">
                    ${logoHtml}
                    <span style="font-size: 0.75rem; color: #6b7280; font-weight: 500;">Sponsored by ${escapeHtml(sponsor.display_name)}</span>
                </div>
            `;
        }
        
        function renderSponsorAttribution(sponsor, isSponsored) {
            if (!isSponsored || !sponsor) return '';
            return `<span style="font-size: 0.75rem; color: #6b7280;">by ${escapeHtml(sponsor.display_name)}</span>`;
        }
        
        function renderMedia(mediaUrls) {
            if (!mediaUrls || mediaUrls.length === 0) return '';
            
            // Decode HTML entities from URLs
            const cleanUrls = mediaUrls.map(url => {
                if (!url) return '';
                const textarea = document.createElement('textarea');
                textarea.innerHTML = url;
                return textarea.value.trim();
            }).filter(url => url && url.startsWith('http'));
            
            if (cleanUrls.length === 0) return '';
            
            const mediaItems = cleanUrls.slice(0, 4);
            const hasMore = cleanUrls.length > 4;
            let gridClass = 'single';
            if (mediaItems.length === 2) gridClass = 'double';
            else if (mediaItems.length === 3) gridClass = 'triple';
            else if (mediaItems.length >= 4) gridClass = 'multiple';
            
            return `
                <div class="moment-media ${gridClass}" onclick="openMediaGallery(${JSON.stringify(cleanUrls).replace(/"/g, '&quot;')})">
                    ${mediaItems.map((url, index) => {
                        const ext = url.split('.').pop()?.toLowerCase() || '';
                        const mediaClass = gridClass === 'single' ? 'single' : (gridClass === 'double' ? 'double' : (gridClass === 'triple' ? 'triple' : 'multiple'));
                        
                        if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) {
                            return `
                                <div class="media-preview ${mediaClass}">
                                    <img src="${escapeHtml(url)}" alt="Moment image" loading="lazy" onerror="this.style.opacity='0.5'; this.alt='Image loading failed'">
                                    ${hasMore && index === 3 ? `<div class="media-overlay">+${mediaUrls.length - 4} more</div>` : ''}
                                </div>
                            `;
                        } else if (['mp4', 'webm', 'mov', '3gp'].includes(ext)) {
                            return `
                                <div class="media-preview ${mediaClass}">
                                    <video preload="metadata" muted>
                                        <source src="${escapeHtml(url)}">
                                    </video>
                                    <div class="media-icon">‚ñ∂Ô∏è</div>
                                    ${hasMore && index === 3 ? `<div class="media-overlay">+${mediaUrls.length - 4} more</div>` : ''}
                                </div>
                            `;
                        } else if (['mp3', 'wav', 'ogg', 'm4a', 'aac', 'amr'].includes(ext)) {
                            return `
                                <div class="media-preview ${mediaClass}">
                                    <div class="media-icon">üéß</div>
                                    <audio controls style="position: absolute; bottom: 0; width: 100%; height: 30px; opacity: 0.9;">
                                        <source src="${escapeHtml(url)}">
                                    </audio>
                                </div>
                            `;
                        } else {
                            return `
                                <div class="media-preview ${mediaClass}">
                                    <div class="media-icon">üìÑ</div>
                                    <a href="${escapeHtml(url)}" target="_blank" style="position: absolute; inset: 0;"></a>
                                </div>
                            `;
                        }
                    }).join('')}
                </div>
            `;
        }
        
        function renderComments(comments) {
            if (!comments || comments.length === 0) return '';
            
            return `
                <div class="moment-comments">
                    <h4 class="comments-header">üí¨ Community Comments (${comments.length})</h4>
                    ${comments.slice(0, 3).map(comment => `
                        <div class="comment-item ${comment.featured ? 'featured' : ''}">
                            <div class="comment-content">${escapeHtml(comment.content)}</div>
                            <div class="comment-meta">
                                <span class="comment-author">Community member</span>
                                <span class="comment-time">${formatDate(comment.created_at)}</span>
                                ${comment.reply_count > 0 ? `<span class="comment-replies">${comment.reply_count} replies</span>` : ''}
                            </div>
                            ${comment.replies && comment.replies.length > 0 ? `
                                <div class="comment-replies-list">
                                    ${comment.replies.slice(0, 2).map(reply => `
                                        <div class="comment-reply">
                                            <div class="reply-content">${escapeHtml(reply.content)}</div>
                                            <div class="reply-meta">${formatDate(reply.created_at)}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                    ${comments.length > 3 ? `
                        <div class="comments-more">
                            <button class="expand-comments" onclick="loadMoreComments(this)" data-moment-id="${comments[0].moment_id}">
                                View all ${comments.length} comments
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        function toggleContent(button) {
            // Use the enhanced Markdown-aware toggle function
            toggleMomentContent(button);
        }
        
        function openMediaGallery(mediaUrls) {
            if (!mediaUrls || mediaUrls.length === 0) return;
            
            // Create modal gallery
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.9); z-index: 1000;
                display: flex; align-items: center; justify-content: center;
                padding: 1rem;
            `;
            
            const gallery = document.createElement('div');
            gallery.style.cssText = `
                max-width: 90vw; max-height: 90vh;
                background: white; border-radius: 1rem;
                overflow: hidden; position: relative;
            `;
            
            let currentIndex = 0;
            
            function renderGalleryItem(url, index) {
                const ext = url.split('.').pop()?.toLowerCase() || '';
                
                if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) {
                    return `<img src="${escapeHtml(url)}" style="max-width: 100%; max-height: 80vh; object-fit: contain;">`;
                } else if (['mp4', 'webm', 'mov', '3gp'].includes(ext)) {
                    return `<video controls style="max-width: 100%; max-height: 80vh;"><source src="${escapeHtml(url)}"></video>`;
                } else if (['mp3', 'wav', 'ogg', 'm4a', 'aac', 'amr'].includes(ext)) {
                    return `<audio controls style="width: 100%;"><source src="${escapeHtml(url)}"></audio>`;
                }
                return `<iframe src="${escapeHtml(url)}" style="width: 100%; height: 80vh;"></iframe>`;
            }
            
            function updateGallery() {
                gallery.innerHTML = `
                    <div style="padding: 1rem; text-align: center;">
                        <div style="margin-bottom: 1rem;">
                            ${renderGalleryItem(mediaUrls[currentIndex], currentIndex)}
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <button onclick="this.closest('.gallery-modal').previousIndex()" ${currentIndex === 0 ? 'disabled' : ''} 
                                style="padding: 0.5rem 1rem; border: none; background: #2563eb; color: white; border-radius: 0.5rem; cursor: pointer;">Previous</button>
                            <span style="color: #6b7280;">${currentIndex + 1} of ${mediaUrls.length}</span>
                            <button onclick="this.closest('.gallery-modal').nextIndex()" ${currentIndex === mediaUrls.length - 1 ? 'disabled' : ''}
                                style="padding: 0.5rem 1rem; border: none; background: #2563eb; color: white; border-radius: 0.5rem; cursor: pointer;">Next</button>
                        </div>
                        <button onclick="this.closest('.gallery-modal').remove()" 
                            style="position: absolute; top: 1rem; right: 1rem; background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer;">√ó</button>
                    </div>
                `;
            }
            
            modal.className = 'gallery-modal';
            modal.previousIndex = () => { if (currentIndex > 0) { currentIndex--; updateGallery(); } };
            modal.nextIndex = () => { if (currentIndex < mediaUrls.length - 1) { currentIndex++; updateGallery(); } };
            
            modal.appendChild(gallery);
            updateGallery();
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
            
            document.body.appendChild(modal);
        }
        
        async function loadMoreComments(button) {
            const momentId = button.dataset.momentId;
            try {
                const response = await fetch(`/api/comments/${momentId}`);
                const data = await response.json();
                
                const commentsContainer = button.closest('.moment-comments');
                commentsContainer.innerHTML = renderComments(data.comments);
            } catch (error) {
                console.error('Failed to load more comments:', error);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            
            return date.toLocaleDateString('en-ZA', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        // Filter functionality
        document.getElementById('region-filter').addEventListener('change', (e) => {
            currentFilters.region = e.target.value;
            loadMoments();
        });
        
        document.getElementById('category-filter').addEventListener('change', (e) => {
            currentFilters.category = e.target.value;
            loadMoments();
        });
        
        document.getElementById('source-filter').addEventListener('change', (e) => {
            currentFilters.source = e.target.value;
            loadMoments();
        });

        // Load data on page load
        loadStats();
        loadMoments();
        
        // Real-time updates every 30 seconds for community content
        setInterval(() => {
            loadStats();
            loadMoments();
        }, 30 * 1000);
    </script>
    <script src="/js/moments-renderer.js"></script>
    <script src="/js/analytics.js"></script>
</body>
</html>