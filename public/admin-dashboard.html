<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unami Foundation Moments - Admin</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2563eb">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; line-height: 1.5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
        .header { background: #2563eb; color: white; padding: 1rem 0; margin-bottom: 1.5rem; position: sticky; top: 0; z-index: 100; }
        .header h1 { text-align: center; font-size: clamp(1.25rem, 4vw, 1.5rem); margin-bottom: 0.5rem; }
        .nav { display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem; }
        .nav button { background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem 0.75rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; transition: all 0.2s; }
        .nav button.active { background: rgba(255,255,255,0.3); }
        .nav button:hover { background: rgba(255,255,255,0.25); }
        .section { display: none; }
        .section.active { display: block; }
        .card { background: white; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.25rem; font-weight: 500; font-size: 0.875rem; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 1rem; }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .btn { background: #2563eb; color: white; border: none; padding: 0.75rem 1rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; font-weight: 500; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn:hover { background: #1d4ed8; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-sm { padding: 0.5rem 0.75rem; font-size: 0.75rem; }
        .btn-danger { background: #dc2626; }
        .btn-danger:hover { background: #b91c1c; }
        .btn-success { background: #16a34a; }
        .btn-success:hover { background: #15803d; }
        .btn-secondary { background: #6b7280; }
        .btn-secondary:hover { background: #4b5563; }
        .moment-item { border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; margin-bottom: 0.75rem; }
        .moment-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; gap: 1rem; }
        .moment-info { flex: 1; min-width: 0; }
        .moment-actions { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .moment-title { font-weight: 600; color: #1f2937; margin-bottom: 0.25rem; word-break: break-word; }
        .moment-meta { font-size: 0.75rem; color: #6b7280; }
        .moment-content { margin-bottom: 0.75rem; color: #374151; font-size: 0.875rem; }
        .status-badge { padding: 0.25rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
        .status-draft { background: #f3f4f6; color: #374151; }
        .status-scheduled { background: #fef3c7; color: #92400e; }
        .status-broadcasted { background: #d1fae5; color: #065f46; }
        .status-cancelled { background: #fee2e2; color: #991b1b; }
        .analytics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
        .stat-card { text-align: center; padding: 1rem; }
        .stat-number { font-size: clamp(1.5rem, 6vw, 2rem); font-weight: bold; color: #2563eb; }
        .stat-label { color: #6b7280; margin-top: 0.25rem; font-size: 0.875rem; }
        .loading { text-align: center; padding: 2rem; color: #6b7280; }
        .error { background: #fef2f2; color: #dc2626; padding: 0.75rem; border-radius: 0.375rem; margin-bottom: 1rem; font-size: 0.875rem; }
        .success { background: #f0fdf4; color: #16a34a; padding: 0.75rem; border-radius: 0.375rem; margin-bottom: 1rem; font-size: 0.875rem; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; padding: 1rem; }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: 0.5rem; padding: 1.5rem; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .modal-title { font-size: 1.125rem; font-weight: 600; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280; }
        .filters { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
        .filter-select { padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; }
        .search-box { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 1rem; }
        .empty-state { text-align: center; padding: 3rem 1rem; color: #6b7280; }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; }
        .pagination { display: flex; justify-content: center; gap: 0.5rem; margin-top: 1rem; }
        .page-btn { padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; background: white; border-radius: 0.375rem; cursor: pointer; }
        .page-btn.active { background: #2563eb; color: white; border-color: #2563eb; }
        @media (max-width: 768px) {
            .container { padding: 0.5rem; }
            .card { padding: 0.75rem; }
            .moment-header { flex-direction: column; align-items: stretch; }
            .moment-actions { justify-content: flex-start; }
            .analytics-grid { grid-template-columns: repeat(2, 1fr); }
            .nav { gap: 0.25rem; }
            .nav button { padding: 0.5rem; font-size: 0.75rem; }
            .modal-content { margin: 0.5rem; padding: 1rem; }
        }
        @media (max-width: 480px) {
            .analytics-grid { grid-template-columns: 1fr; }
            .filters { flex-direction: column; }
            .filter-select { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>
                <img src="/Placeholder-logo.png" alt="logo" style="height:40px;vertical-align:middle;margin-right:8px;">
                üì¢ Unami Foundation Moments
            </h1>
            <div class="nav">
                <button data-section="dashboard" class="active">Dashboard</button>
                <button data-section="moments">Moments</button>
                <button data-section="campaigns">Campaigns</button>
                <button data-section="sponsors">Sponsors</button>
                <button data-section="broadcasts">Broadcasts</button>
                <button data-section="moderation">Moderation</button>
                <button data-section="subscribers">Subscribers</button>
                <button data-section="settings">Settings</button>
            </div>
        </div>
    </div>
    <div style="position: absolute; top: 12px; right: 16px;">
        <div id="auth-area">
            <span id="user-email" style="color: white; font-size: 0.75rem; margin-right: 8px;"></span>
            <button id="sign-out" class="btn btn-sm">Sign Out</button>
        </div>
    </div>

    <div class="container">
        <!-- Dashboard Section -->
        <div id="dashboard" class="section active">
            <div class="card">
                <h2>Analytics Overview</h2>
                <div id="analytics" class="analytics-grid">
                    <div class="loading">Loading analytics...</div>
                </div>
            </div>
            <div class="card">
                <h3>Recent Activity</h3>
                <div id="recent-activity">
                    <div class="loading">Loading recent activity...</div>
                </div>
            </div>
        </div>

        <!-- Moments List Section -->
        <div id="moments" class="section">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                    <h2>All Moments</h2>
                    <button class="btn" data-action="create-moment">+ New Moment</button>
                </div>
                <div class="filters">
                    <select class="filter-select" id="status-filter" data-filter="status">
                        <option value="">All Status</option>
                        <option value="draft">Draft</option>
                        <option value="scheduled">Scheduled</option>
                        <option value="broadcasted">Broadcasted</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                    <select class="filter-select" id="region-filter" data-filter="region">
                        <option value="">All Regions</option>
                        <option value="KZN">KwaZulu-Natal</option>
                        <option value="WC">Western Cape</option>
                        <option value="GP">Gauteng</option>
                        <option value="EC">Eastern Cape</option>
                        <option value="FS">Free State</option>
                        <option value="LP">Limpopo</option>
                        <option value="MP">Mpumalanga</option>
                        <option value="NC">Northern Cape</option>
                        <option value="NW">North West</option>
                    </select>
                    <select class="filter-select" id="category-filter" data-filter="category">
                        <option value="">All Categories</option>
                        <option value="Education">Education</option>
                        <option value="Safety">Safety</option>
                        <option value="Culture">Culture</option>
                        <option value="Opportunity">Opportunity</option>
                        <option value="Events">Events</option>
                        <option value="Health">Health</option>
                        <option value="Technology">Technology</option>
                    </select>
                </div>
                <input type="text" class="search-box" id="search-box" placeholder="Search moments..." data-search="moments">
                <div id="moments-list">
                    <div class="loading">Loading moments...</div>
                </div>
                <div id="moments-pagination" class="pagination"></div>
            </div>
        </div>

        <!-- Campaigns Section -->
        <div id="campaigns" class="section">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                    <h2>Campaign Management</h2>
                    <button class="btn" data-action="create-campaign">+ New Campaign</button>
                </div>
                <div class="filters">
                    <select class="filter-select" id="campaign-status-filter" data-filter="campaign-status">
                        <option value="">All Status</option>
                        <option value="pending_review">Pending Review</option>
                        <option value="approved">Approved</option>
                        <option value="published">Published</option>
                        <option value="rejected">Rejected</option>
                    </select>
                    <select class="filter-select" id="campaign-sponsor-filter" data-filter="campaign-sponsor">
                        <option value="">All Sponsors</option>
                    </select>
                </div>
                <div id="campaigns-list">
                    <div class="loading">Loading campaigns...</div>
                </div>
            </div>
        </div>
        <div id="create" class="section">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 id="create-title">Create New Moment</h2>
                    <button class="btn btn-secondary" data-action="back-to-moments">‚Üê Back</button>
                </div>
                <div id="create-message"></div>
                <form id="create-form">
                    <input type="hidden" id="edit-id" name="id">
                    <div class="form-group">
                        <label>Title *</label>
                        <input type="text" name="title" required maxlength="200" placeholder="Enter moment title...">
                    </div>
                    <div class="form-group">
                        <label>Content *</label>
                        <textarea name="content" required maxlength="2000" placeholder="Write your moment content..."></textarea>
                        <small style="color: #6b7280;">Characters: <span id="char-count">0</span>/2000</small>
                    </div>
                    <div class="form-group">
                        <label>Region *</label>
                        <select name="region" required>
                            <option value="">Select Region</option>
                            <option value="KZN">KwaZulu-Natal</option>
                            <option value="WC">Western Cape</option>
                            <option value="GP">Gauteng</option>
                            <option value="EC">Eastern Cape</option>
                            <option value="FS">Free State</option>
                            <option value="LP">Limpopo</option>
                            <option value="MP">Mpumalanga</option>
                            <option value="NC">Northern Cape</option>
                            <option value="NW">North West</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Category *</label>
                        <select name="category" required>
                            <option value="">Select Category</option>
                            <option value="Education">Education</option>
                            <option value="Safety">Safety</option>
                            <option value="Culture">Culture</option>
                            <option value="Opportunity">Opportunity</option>
                            <option value="Events">Events</option>
                            <option value="Health">Health</option>
                            <option value="Technology">Technology</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Sponsor</label>
                        <select name="sponsor_id" id="sponsor-select">
                            <option value="">No Sponsor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>PWA Link (optional)</label>
                        <input type="url" name="pwa_link" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>Schedule For (optional)</label>
                        <input type="datetime-local" name="scheduled_at">
                        <small style="color: #6b7280;">Leave empty to save as draft</small>
                    </div>
                    <div class="form-group">
                        <label>Media files (optional)</label>
                        <input type="file" name="media_files" id="media_files" multiple accept="image/*,video/*,audio/*">
                        <small style="color: #6b7280;">Uploaded files will be stored and included in the Moment.</small>
                    </div>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button type="submit" class="btn" id="submit-btn">Create Moment</button>
                        <button type="button" class="btn btn-secondary" data-action="reset-form">Reset</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Sponsors Section -->
        <div id="sponsors" class="section">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                    <h2>Sponsors</h2>
                    <button class="btn" data-action="new-sponsor">+ New Sponsor</button>
                </div>
                <div id="sponsors-list">
                    <div class="loading">Loading sponsors...</div>
                </div>
            </div>
        </div>

        <!-- Broadcasts Section -->
        <div id="broadcasts" class="section">
            <div class="card">
                <h2>Broadcast History</h2>
                <div id="broadcasts-list">
                    <div class="loading">Loading broadcasts...</div>
                </div>
            </div>
        </div>

        <!-- Moderation Section -->
        <div id="moderation" class="section">
            <div class="card">
                <h2>Content Moderation</h2>
                <div class="filters">
                    <select class="filter-select" id="moderation-filter" data-filter="moderation">
                        <option value="all">All Content</option>
                        <option value="flagged">Flagged Only</option>
                        <option value="escalated">Escalated</option>
                        <option value="reviewed">Reviewed</option>
                    </select>
                </div>
                <div id="moderation-list">
                    <div class="loading">Loading flagged content...</div>
                </div>
            </div>
        </div>

        <!-- Subscribers Section -->
        <div id="subscribers" class="section">
            <div class="card">
                <h2>Subscriber Management</h2>
                <div class="filters">
                    <select class="filter-select" id="subscriber-filter" data-filter="subscribers">
                        <option value="all">All Subscribers</option>
                        <option value="active">Active Only</option>
                        <option value="inactive">Opted Out</option>
                    </select>
                </div>
                <div id="subscribers-list">
                    <div class="loading">Loading subscribers...</div>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settings" class="section">
            <div class="card">
                <h2>System Settings</h2>
                <div id="settings-message"></div>
                <div id="settings-list">
                    <div class="loading">Loading settings...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Campaign Modal -->
    <div id="campaign-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="campaign-modal-title">Create Campaign</h3>
                <button class="close-btn" data-action="close-campaign-modal">&times;</button>
            </div>
            <div id="campaign-message"></div>
            <form id="campaign-form">
                <input type="hidden" id="campaign-edit-id" name="id">
                <div class="form-group">
                    <label>Campaign Title *</label>
                    <input type="text" name="title" required placeholder="Campaign title">
                </div>
                <div class="form-group">
                    <label>Content *</label>
                    <textarea name="content" required rows="4" placeholder="Campaign content..."></textarea>
                </div>
                <div class="form-group">
                    <label>Sponsor</label>
                    <select name="sponsor_id" id="campaign-sponsor-select">
                        <option value="">Select Sponsor</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Budget (ZAR)</label>
                    <input type="number" name="budget" min="0" step="0.01" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>Target Regions</label>
                    <div id="campaign-regions" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 8px;">
                        <label><input type="checkbox" name="target_regions" value="KZN"> KZN</label>
                        <label><input type="checkbox" name="target_regions" value="WC"> WC</label>
                        <label><input type="checkbox" name="target_regions" value="GP"> GP</label>
                        <label><input type="checkbox" name="target_regions" value="EC"> EC</label>
                        <label><input type="checkbox" name="target_regions" value="FS"> FS</label>
                        <label><input type="checkbox" name="target_regions" value="LP"> LP</label>
                        <label><input type="checkbox" name="target_regions" value="MP"> MP</label>
                        <label><input type="checkbox" name="target_regions" value="NC"> NC</label>
                        <label><input type="checkbox" name="target_regions" value="NW"> NW</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Target Categories</label>
                    <div id="campaign-categories" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 8px;">
                        <label><input type="checkbox" name="target_categories" value="Education"> Education</label>
                        <label><input type="checkbox" name="target_categories" value="Safety"> Safety</label>
                        <label><input type="checkbox" name="target_categories" value="Culture"> Culture</label>
                        <label><input type="checkbox" name="target_categories" value="Opportunity"> Opportunity</label>
                        <label><input type="checkbox" name="target_categories" value="Events"> Events</label>
                        <label><input type="checkbox" name="target_categories" value="Health"> Health</label>
                        <label><input type="checkbox" name="target_categories" value="Technology"> Technology</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Scheduled For</label>
                    <input type="datetime-local" name="scheduled_at">
                </div>
                <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" data-action="cancel-campaign">Cancel</button>
                    <button type="submit" class="btn" id="campaign-submit-btn">Create Campaign</button>
                </div>
            </form>
        </div>
    </div>
    <div id="sponsor-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="sponsor-modal-title">Create Sponsor</h3>
                <button class="close-btn" data-action="close-sponsor-modal">&times;</button>
            </div>
            <div id="sponsor-message"></div>
            <form id="sponsor-form">
                <input type="hidden" id="sponsor-edit-id" name="id">
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" name="name" required placeholder="sponsor_name">
                </div>
                <div class="form-group">
                    <label>Display Name *</label>
                    <input type="text" name="display_name" required placeholder="Sponsor Display Name">
                </div>
                <div class="form-group">
                    <label>Contact Email</label>
                    <input type="email" name="contact_email" placeholder="contact@sponsor.com">
                </div>
                <div class="form-group">
                    <label>Website URL</label>
                    <input type="url" name="website_url" placeholder="https://sponsor.com">
                </div>
                <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" data-action="cancel-sponsor">Cancel</button>
                    <button type="submit" class="btn" id="sponsor-submit-btn">Create Sponsor</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Confirm Action</h3>
                <button class="close-btn" data-action="close-confirm-modal">&times;</button>
            </div>
            <p id="confirm-message">Are you sure?</p>
            <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem;">
                <button class="btn btn-secondary" data-action="cancel-confirm">Cancel</button>
                <button class="btn btn-danger" id="confirm-btn" data-action="confirm-action">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // Direct Supabase auth check without library
        async function getSession() {
            const token = localStorage.getItem('supabase.auth.token');
            if (!token) return null;
            try {
                const parsed = JSON.parse(token);
                return parsed.access_token ? { user: { email: parsed.user?.email || 'admin' } } : null;
            } catch {
                return null;
            }
        }
        
        async function signOut() {
            localStorage.removeItem('supabase.auth.token');
        }
        
        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const session = await getSession();
                
                if (!session) {
                    window.location.href = '/login';
                    return;
                }
                
                // Show user email and setup logout
                const userEmailEl = document.getElementById('user-email');
                const signOutEl = document.getElementById('sign-out');
                
                if (userEmailEl) userEmailEl.textContent = session.user.email;
                if (signOutEl) {
                    signOutEl.addEventListener('click', async () => {
                        await signOut();
                        window.location.href = '/login';
                    });
                }
                
            } catch (error) {
                console.error('Auth error:', error);
                window.location.href = '/login';
            }
        });
    </script>
    <script src="/js/admin.js"></script>
</body>
</html>