#!/usr/bin/env bash\nset -euo pipefail\n\n# Database Migration Runner for Unami Foundation Moments\n# Applies SQL migrations in the correct order\n\necho \"\ud83d\udcbe Running Database Migrations\"\necho \"==============================\"\n\n# Colors for output\nRED='\\033[0;31m'\nGREEN='\\033[0;32m'\nYELLOW='\\033[1;33m'\nBLUE='\\033[0;34m'\nNC='\\033[0m' # No Color\n\n# Check required environment variables\nrequired_vars=(\"SUPABASE_URL\" \"SUPABASE_SERVICE_KEY\")\nfor var in \"${required_vars[@]}\"; do\n    if [ -z \"${!var:-}\" ]; then\n        echo -e \"${RED}\u274c ERROR: $var environment variable is required${NC}\"\n        exit 1\n    fi\ndone\n\n# Migration files in order\nMIGRATIONS=(\n    \"supabase/schema.sql:Base schema with core tables\"\n    \"supabase/moments-schema.sql:Moments-specific tables and functions\"\n    \"supabase/rbac-complete.sql:RBAC system with admin roles\"\n    \"supabase/rbac.sql:Row Level Security policies\"\n    \"supabase/media-enhanced.sql:Enhanced media storage schema\"\n    \"supabase/enhanced-schema.sql:Additional enhancements (if needed)\"\n)\n\n# Function to run SQL file\nrun_migration() {\n    local file=$1\n    local description=$2\n    \n    echo -e \"\\n${BLUE}\ud83d\udcdd Running: $description${NC}\"\n    echo \"File: $file\"\n    \n    if [ ! -f \"$file\" ]; then\n        echo -e \"${YELLOW}\u26a0\ufe0f  Skipping: File not found${NC}\"\n        return 0\n    fi\n    \n    # Check if we can connect to database\n    if command -v psql >/dev/null 2>&1 && [ -n \"${DATABASE_URL:-}\" ]; then\n        echo \"Executing via psql...\"\n        if psql \"$DATABASE_URL\" -f \"$file\" --set ON_ERROR_STOP=on; then\n            echo -e \"${GREEN}\u2705 Migration completed successfully${NC}\"\n        else\n            echo -e \"${RED}\u274c Migration failed${NC}\"\n            return 1\n        fi\n    else\n        echo -e \"${YELLOW}\ud83d\udccb Manual execution required:${NC}\"\n        echo \"1. Open Supabase SQL Editor: https://app.supabase.com/project/YOUR_PROJECT/sql\"\n        echo \"2. Copy and paste the contents of: $file\"\n        echo \"3. Execute the SQL\"\n        echo \"\"\n        echo \"Press Enter when completed, or Ctrl+C to abort...\"\n        read -r\n    fi\n}\n\n# Function to verify migration\nverify_migration() {\n    local table_name=$1\n    local description=$2\n    \n    echo -n \"Verifying $description... \"\n    \n    # This would require a database connection to verify\n    # For now, we'll just indicate manual verification needed\n    echo -e \"${YELLOW}(manual verification required)${NC}\"\n}\n\n# Main migration process\necho \"Starting database migrations...\"\necho \"Supabase URL: ${SUPABASE_URL}\"\necho \"\"\n\n# Run each migration\nfor migration in \"${MIGRATIONS[@]}\"; do\n    IFS=':' read -r file description <<< \"$migration\"\n    \n    if ! run_migration \"$file\" \"$description\"; then\n        echo -e \"${RED}\u274c Migration failed: $file${NC}\"\n        echo \"Please fix the issue and run the migration again.\"\n        exit 1\n    fi\ndone\n\necho -e \"\\n${GREEN}\ud83c\udf89 All migrations completed!${NC}\"\n\n# Post-migration setup\necho -e \"\\n${BLUE}\ud83d\udd27 Post-Migration Setup${NC}\"\necho \"========================\"\n\necho \"1. Creating storage buckets...\"\nif node scripts/create_storage_bucket.js; then\n    echo -e \"${GREEN}\u2705 Storage buckets created${NC}\"\nelse\n    echo -e \"${YELLOW}\u26a0\ufe0f  Storage bucket creation failed - run manually${NC}\"\nfi\n\necho -e \"\\n2. Setting up superadmin role...\"\nif [ -n \"${SUPERADMIN_USER_ID:-}\" ]; then\n    if bash scripts/seed_superadmin.sh; then\n        echo -e \"${GREEN}\u2705 Superadmin role seeded${NC}\"\n    else\n        echo -e \"${YELLOW}\u26a0\ufe0f  Superadmin seeding failed - run manually${NC}\"\n    fi\nelse\n    echo -e \"${YELLOW}\u26a0\ufe0f  SUPERADMIN_USER_ID not set - run seed script manually${NC}\"\nfi\n\necho -e \"\\n${BLUE}\ud83e\uddea Running Tests${NC}\"\necho \"===============\"\n\necho \"Testing database connection and schema...\"\nif node test-message-storage.js; then\n    echo -e \"${GREEN}\u2705 Database tests passed${NC}\"\nelse\n    echo -e \"${YELLOW}\u26a0\ufe0f  Some database tests failed - check configuration${NC}\"\nfi\n\necho -e \"\\n${GREEN}\ud83c\udf86 Migration Process Complete!${NC}\"\necho \"\"\necho \"Next steps:\"\necho \"1. Verify all tables exist in Supabase dashboard\"\necho \"2. Test admin authentication with seeded superadmin\"\necho \"3. Upload a test media file to verify storage\"\necho \"4. Run full integration tests\"\necho \"\"\necho \"For troubleshooting, see: supabase/RBAC_SETUP.md\"\n\nexit 0", "oldStr": "", "newStr": ""}]